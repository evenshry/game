var isWeixinBrowser=function(){var a=navigator.userAgent.toLowerCase();return(/micromessenger/.test(a))?true:false};if(!isWeixinBrowser()){}var canvasContainer,GameStatus=0;var player,shadow,monsters=[],asideMiles=[],asideCheers=[],asideCheers2=[];var winWidth,winHeight,guideStatus=0,isGuide=false;var startTouchPoint,touchCacheX=0.12,touchCacheY=0.2;var startTime,pauseTime,gmfCounts=0,stepLength=1800;$(function(){loadPlayerCnt();initAudio();$("#submitPwd").on("touchstart",function(){var c=$("#password").val();if(c&&c.length>0){checkPassport(c)}});$("#gameBefore").on("touchstart","#btnStart",function(c){$("#gameBefore").hide();$("#gameing").show();initStage();musicBg.play();stopPropagation(c)});$("#gameBefore").on("touchstart",".present",function(c){$("#activity").show();stopPropagation(c)});$("body").on("touchstart touchmove",function(c){c.preventDefault()});$("input").on("touchstart",function(c){$(this).focus()});$(".dialog").on("touchstart",".close",function(c){$(this).closest(".dialog").hide();c.preventDefault()});$("#gameAfter").on("touchstart","#btnReStart",function(c){$("#gameAfter").hide();resetStage();if(isPlayMusic){musicBg.play()}startGame();stopPropagation(c)}).on("touchstart","#btnTopTen",function(c){loadGamerTop10(true);c.preventDefault()}).on("touchstart","#btnRaffle",function(c){loadGamerRaffle();c.preventDefault()});$("#inputBox").on("touchstart","#submitInfo",function(c){submitInfo();c.preventDefault()});$(".dialog_navbar").on("touchstart",".dialog_navbar_item",function(c){$(this).siblings(".dialog_navbar_item").removeClass("selected");$(this).addClass("selected");$(this).parent().siblings("div").hide();$(this).parent().siblings("div").eq($(this).index()).show()});var a=$.fn.cookie("uPhone");if(a!=null){$(".dialog_navbar").find(".dialog_navbar_item").eq(1).show()}else{$(".dialog_navbar").find(".dialog_navbar_item").eq(1).hide()}var b=$.fn.cookie("hasRaffle");if(b!=null&&b==1){$("#btnRaffle").hide();$(".dialog_navbar").find(".dialog_navbar_item").eq(2).show()}else{$("#btnRaffle").show();$(".dialog_navbar").find(".dialog_navbar_item").eq(2).hide()}isGuide=$.fn.cookie("isGuide")});var showGuide=function(c){var d=util.toucher(document.getElementById("guide"));var a=winHeight>winWidth?winWidth:winHeight;var e=false;d.on("swipe",function(g){var f=$("#guide").data("index");if(g.moveX>=a*touchCacheX&&f!=2){if(!player.moving&&!player.jumping){player.moving=true;player.moveDirect=1;shadow.moving=true;shadow.moveDirect=1;e=true}}else{if(g.moveX<=-a*touchCacheX&&f!=2){if(!player.moving&&!player.jumping){player.moving=true;player.moveDirect=-1;shadow.moving=true;shadow.moveDirect=-1;e=true}}}if(g.moveY<=-a*touchCacheY&&f==2){if(!player.jumping){player.jumping=true;player.jumpDirect=1;e=true}}if(e){$("#guide").hide();GameStatus=0;guideStatus=2;if(f>=3){nextMonTime=currTime+1000;isGuide=true;guideStatus=-1;startTime=new Date().getTime();$.fn.cookie("isGuide",isGuide,{expires:120})}else{nextMonTime=currTime+1200;setTimeout(function(){guideStatus=0},1200)}e=false}stopPropagation(g)});if(c===1){var b=$("#guide").find(".container");b.addClass("guide_bg_1").find("article").text("");$("#guide").show()}else{if(c===2){var b=$("#guide").find(".container");b.removeClass("guide_bg_1").addClass("guide_bg_2").find("article").text("");$("#guide").show()}else{var b=$("#guide").find(".container");b.removeClass("guide_bg_2").addClass("guide_bg_1").find("article").html("Give me five！<br/>为市运会助力！<br/>");$("#guide").show()}}$("#guide").data("index",c)};var initStage=function(){canvasContainer=document.getElementById("gameing");window.onresize=resizeHandler;resetStage();var b=util.toucher(document.getElementById("gameing"));var a=winHeight>winWidth?winWidth:winHeight;b.on("swipe",function(c){if(isGuide){if(c.moveX>=a*touchCacheX){if(!player.moving&&!player.jumping){player.moving=true;player.moveDirect=1;shadow.moving=true;shadow.moveDirect=1}}else{if(c.moveX<=-a*touchCacheX){if(!player.moving&&!player.jumping){player.moving=true;player.moveDirect=-1;shadow.moving=true;shadow.moveDirect=-1}}}if(c.moveY<=-a*touchCacheY){if(!player.jumping){player.jumping=true;player.jumpDirect=1}}}stopPropagation(c)});startGame()};var startGame=function(){startTime=new Date().getTime();gmfCounts=0;DF.AddTime=1;noMoreMonster=false;GameStatus=0;requestAnimationFrame(loop,canvasContainer)};var resizeHandler=function(){resetStage()};var resetStage=function(){winWidth=$(canvasContainer).width();winHeight=$(canvasContainer).height();DF.M.maxPath=getScaleY(HEIGHT-yl-25);DF.M.maxPathMile=getScaleY(HEIGHT-yl-25);DF.M.moveSpeed=winHeight*0.0068;DF.P.moveSpeed=winHeight*0.006;var a=Math.abs((getScaleX(xl)-getScaleX(xd1))/(winHeight-getScaleY(yl)));DF.P.pathWidth=DF.M.maxPath/10*6*a;if(GAME.canvas){canvasContainer.removeChild(GAME.canvas)}GAME.canvas=document.createElement("canvas");GAME.canvas.width=winWidth;GAME.canvas.height=winHeight;GAME.context=GAME.canvas.getContext("2d");canvasContainer.appendChild(GAME.canvas);GAME.context.clearRect(0,0,GAME.canvas.width,GAME.canvas.height);
document.getElementById("timer").innerText="";document.getElementById("miles").innerText="";GAME.children={};player=null;shadow=null;monsters=[];asideMiles=[];asideCheers=[];asideCheers2=[];mileIndex=0;mileIndex=0;cheerIndex=1;cheerIndex2=1;shadow=new Shadow();player=new Player()};window.requestAnimationFrame=window.__requestAnimationFrame||window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(function(){return function(a){window.setTimeout(a,16)}})();var loop=function(){currTime=new Date().getTime();if(guideStatus==2&&pauseTime>0){startTime+=currTime-pauseTime+100;pauseTime=0}if(guideStatus!=1){var a=currTime-startTime;document.getElementById("timer").innerText=formatMilli(a);document.getElementById("miles").innerText=gmfCounts}if(GameStatus!=3){shadow.update();player.update();if(GameStatus!=1){renderMonster();if(isGuide){renderAsideMile();renderAsideCheer();renderAsideCheer2()}GAME.updateChildren()}requestAnimationFrame(loop)}else{musicBg.pause();if(isPlayMusic){musicWin.play()}finishGame(formatMilli(a),gmfCounts)}};var nextMonster=false,monIndex=0,nextMonTime=null,currTime=null,noMoreMonster=false;var guideSortIndex=[4,2,0];var renderMonster=function(){if(currTime>nextMonTime&&nextMonster){nextMonster=false}if(!nextMonster&&!noMoreMonster&&isGuide){var i=getRoundVal(500,1000);var g=getRoundVal(0,DF.M.types.length+3);if(g>DF.M.types.length-1){g=0}var a,d=winWidth/3;if(g===2){a=getRoundVal(0,1)===0?1:3;c=new Monster(DF.M.types[g],a,d*2,d,monIndex);c.k=Math.abs((getScaleX(xlc)-d)/(winHeight-getScaleY(yl)))}else{if(g===4){a=getRoundVal(1,2);c=new Monster(DF.M.types[g],a,d,d*2,monIndex);c.k=Math.abs((getScaleX(xl)-getScaleX(xd1))/(winHeight-getScaleY(yl)))}else{a=getRoundVal(1,2);c=new Monster(DF.M.types[g],a,d/3*2,d/3*2*1.4,monIndex);c.k=Math.abs((getScaleX(xl)-getScaleX(xd1))/(winHeight-getScaleY(yl)))}}nextMonTime=currTime+i;monsters[monIndex]=c;nextMonster=true;monIndex++}if(!nextMonster&&!noMoreMonster&&!isGuide){var d=winWidth/3,g=guideSortIndex[monIndex],b=d/3*2,f=d/3*2*1.4;if(g===2){b=d*2,f=d;var c=new Monster(DF.M.types[g],player.pathIndex,b,f,monIndex);c.k=Math.abs((getScaleX(xlc)-d)/(winHeight-getScaleY(yl)))}else{if(g===4){b=d,f=d*2;var c=new Monster(DF.M.types[g],2,b,f,monIndex);c.k=Math.abs((getScaleX(xl)-getScaleX(xd1))/(winHeight-getScaleY(yl)))}else{var c=new Monster(DF.M.types[g],2,b,f,monIndex);c.k=Math.abs((getScaleX(xl)-getScaleX(xd1))/(winHeight-getScaleY(yl)))}}monsters[monIndex]=c;nextMonTime=currTime+1000000;nextMonster=true;monIndex++}for(var e in monsters){monsters[e].update(player)}};var nextAsideMile=false,mileIndex=0,nextMileTime=0;var renderAsideMile=function(){if(currTime>=nextMileTime&&nextAsideMile){nextAsideMile=false;mileIndex++}if(!nextAsideMile){if(DF.Miles[mileIndex]){if(DF.Miles[mileIndex]==="100"){var c=new Monster("zhongdian",2,getScaleX(720)*1.2,getScaleY(882)*1.2,cheerIndex+100);c.setAnchorPoint(0.5,1);monsters[monIndex]=c;noMoreMonster=true;monIndex++}nextMileTime=currTime+stepLength;var a=new AsideMile(DF.Miles[mileIndex],100,100,mileIndex);a.setAnchorPoint(1,0);a.setPosition(-10,winHeight);asideMiles[mileIndex]=a;nextAsideMile=true}}for(var b in asideMiles){asideMiles[b].update()}};var nextAsideCheer=false,cheerIndex=1,nextCheerTime=0;var renderAsideCheer=function(){if(currTime>=nextCheerTime&&nextAsideCheer){nextAsideCheer=false;cheerIndex++}if(!nextAsideCheer){nextCheerTime=currTime+stepLength/4;var b=new AsideCheer(getRoundVal(1,2),1,90,140,cheerIndex);b.setAnchorPoint(1,1);var a=getRoundVal(0,1)===0?0:-20;b.setPosition(a,winHeight);asideCheers[cheerIndex]=b;nextAsideCheer=true}for(var c in asideCheers){asideCheers[c].update()}};var nextAsideCheer2=false,cheerIndex2=1,nextCheerTime2=0;var renderAsideCheer2=function(){if(currTime>=nextCheerTime2&&nextAsideCheer2){nextAsideCheer2=false;cheerIndex2++}if(!nextAsideCheer2){nextCheerTime2=currTime+stepLength/4;var b=new AsideCheer(getRoundVal(4,2),2,90,140,cheerIndex2);b.setAnchorPoint(0,1);var a=getRoundVal(0,1)===0?20:0;b.setPosition(winWidth+a,winHeight);asideCheers2[cheerIndex2]=b;nextAsideCheer2=true}for(var c in asideCheers2){asideCheers2[c].update()}};var getRoundVal=function(b,a){return(Math.round(Math.random()*a)+b)};var stopPropagation=function(a){if(a.stopPropagation){a.stopPropagation()}else{a.cancelBubble=true}};var formatMilli=function(c){var b=parseInt(c/1000),a=c%1000;a=parseInt(a/100);return b+"'"+a};var formatMiles=function(a){return parseInt(5*a/1000)+"m"};var dialog=function(a){var b=$("#dialog");if(a.min){b.css({top:"0%",height:"35%"})}if(a.bgImg){a.mask=false;b.css("background-image","url("+a.bgImg+")")}if(a.mask){b.find(".mask").show()}else{b.find(".mask").hide()}b.find(".content").html(a.content);b.show();if(a.delay){setTimeout(function(){b.hide()},a.delay)}};var popupTip=function(c,a){if(!a){a="fc_re"}var e="tip"+new Date().getTime();var d='<div id="'+e+'" class="crashTip self_center '+a+'">'+c+"</div>";
$("#gameing").append(d);var b=$("#"+e).position().top;$("#"+e).css("top",b-winHeight/1.6);setTimeout(function(){$("#"+e).remove()},1000)};var service="server/";var executeAjax=function(a){$.ajax({url:a.url,dataType:"json",type:a.method?a.method:"POST",data:a.data,success:a.success,error:function(c,b){dialog({content:"SERVICES ERROR!",mask:true})}})};var checkPassport=function(a){executeAjax({url:service+"check.php",data:{passport:a},success:function(b){if(b&&b.ret===0){$("#checkPassport").hide()}}})};var loadPlayerCnt=function(){executeAjax({url:service+"pcnt.php",method:"GET",success:function(a){if(a&&a.ret===0){$("#playerCount").text(a.cnt);$.fn.cookie("pcnt",a.cnt,{expires:7})}}});loadGamerGift();loadGamerTop10(false)};var finishGame=function(c,d){var b=$.fn.cookie("uid");var a=parseFloat(c.replace("'","."));executeAjax({url:service+"finish.php",data:{total_time:a,gmf_times:d,uid:b},success:function(e){if(e&&e.ret===0){$.fn.cookie("uid",e.uid,{expires:120});$.fn.cookie("hasRaffle",e.gift,{expires:120});document.getElementById("uid").innerText=e.uid;document.getElementById("timeCount").innerText=c;document.getElementById("gmfCount").innerText=d;document.getElementById("bestTime").innerText=formatMilli(e.total_time*1000);document.getElementById("gmfCountAll").innerText=e.gmf_times;document.getElementById("currentPersent").innerText=Math.round((e.pcnt-e.rank_id)/(e.pcnt)*100);$("#currSort").text(e.rank_id);$("#gameAfter").show();var f=$.fn.cookie("hasRaffle");if(f!=null&&f==1){$("#btnRaffle").hide()}else{$("#btnRaffle").show()}}}})},loadGamerTop10=function(a){var c=$.fn.cookie("uid");var b=$.fn.cookie("uPhone");if(b!=null){$(".dialog_navbar").find(".dialog_navbar_item").eq(1).show().trigger("touchstart");executeAjax({url:service+"top10.php",data:{uid:c},success:function(g){if(g&&g.ret===0){$.fn.cookie("rank_id",g.rank_id,{expires:120});$("#currSort").text(g.rank_id);var h="",e=g.top10;for(var f=0;f<e.length;f++){var d=e[f];h+="<tr><td>No."+(f+1)+"</td><td>"+fmtNull(d["name"])+"</td><td>"+fmtNull(d["phone_no"])+"</td>                                        <td>"+d["total_time"]+"</td><td>"+d["gmf_times"]+"</td></tr>"}$("#topTenBody").html(h);if(a){$("#activity").show()}}}})}else{if(a){$("#inputBox").data("todo",1).show()}}},fmtNull=function(a){return a&&a!=undefined?a:"暂无"};var submitInfo=function(){var a=$("#phone").val();var c=$("#userName").val();if(a===""||a.length!=11){dialog({content:"请填写您的信息以便我们能联系到您！",mask:true,min:true,delay:2000});return false}if(c===""||c.length>16){dialog({content:"请填写您的信息以便我们能联系到您！",mask:true,min:true,delay:2000});return false}var b=$.fn.cookie("uid");executeAjax({url:service+"info.php",data:{uid:b,phone_no:a,name:c},success:function(e){if(e&&e.ret===0){dialog({content:"提交成功！",mask:true,min:true,delay:2000});$.fn.cookie("uPhone",a,{expires:120});var d=$("#inputBox").data("todo");if(d&&d==1){loadGamerTop10(true)}else{if(d&&d==2){loadGamerRaffle()}}}}})},loadGamerRaffle=function(){var a=$.fn.cookie("uPhone");if(a!=null){var b=$.fn.cookie("uid");executeAjax({url:service+"gift.php",data:{uid:b},success:function(c){if(c&&c.ret===0){if(c.win===1){dialog({content:"恭喜您中奖啦！请到兑奖说明中查看详情！",mask:true,min:true,delay:5000})}else{dialog({content:"很遗憾，您没有抽到奖！",mask:true,min:true,delay:5000})}setGiftImage(c.win===1)}$.fn.cookie("hasRaffle",1,{expires:120});$("#btnRaffle").hide();$("#inputBox").data("todo",0).hide();$(".dialog_navbar").find(".dialog_navbar_item").eq(2).show()}})}else{$("#inputBox").data("todo",2).show()}},loadGamerGift=function(){var a=$.fn.cookie("uid");if(a){executeAjax({url:service+"win.php",data:{uid:a},success:function(b){if(b&&b.ret===0){setGiftImage(b.win==1)}}})}else{setGiftImage(false)}},setGiftImage=function(b){var a=$("#giftImage").find("img");if(b){a.attr("src","images/zhongjiang_a.jpg")}else{a.attr("src","images/zhongjiang_b.jpg")}};